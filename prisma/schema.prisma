// =============================================================================
// GENIUS365 PRISMA SCHEMA
// =============================================================================
// This schema maps to the existing Supabase PostgreSQL database.
// Use Prisma for type-safe database queries alongside Supabase Auth.
//
// Commands:
//   npx prisma db pull     - Introspect database and update schema
//   npx prisma generate    - Generate Prisma Client
//   npx prisma migrate dev - Create and apply migrations (dev only)
//   npx prisma studio      - Open database GUI
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
  // NOTE: Only "public" schema - Supabase manages "auth" schema.
  // Don't use "prisma db push" - use raw SQL for schema changes to avoid auth FK conflicts.
}

// =============================================================================
// ENUMS
// =============================================================================

enum AgentProvider {
  vapi
  retell
  @@map("agent_provider")
  @@schema("public")
}

enum VoiceProvider {
  elevenlabs
  deepgram
  azure
  openai
  cartesia
  @@map("voice_provider")
  @@schema("public")
}

enum ModelProvider {
  openai
  anthropic
  google
  groq
  @@map("model_provider")
  @@schema("public")
}

enum TranscriberProvider {
  deepgram
  assemblyai
  openai
  @@map("transcriber_provider")
  @@schema("public")
}

enum CallDirection {
  inbound
  outbound
  @@map("call_direction")
  @@schema("public")
}

enum CallStatus {
  initiated
  ringing
  in_progress
  completed
  failed
  no_answer
  busy
  canceled
  @@map("call_status")
  @@schema("public")
}

enum UserRole {
  org_owner
  org_admin
  org_member
  @@map("user_role")
  @@schema("public")
}

enum UserStatus {
  pending_invitation
  active
  inactive
  suspended
  @@map("user_status")
  @@schema("public")
}

enum PartnerRequestStatus {
  pending
  approved
  rejected
  provisioning
  @@map("partner_request_status")
  @@schema("public")
}

enum ResourceType {
  voice_minutes
  api_calls
  storage_gb
  tts_characters
  llm_tokens
  stt_minutes
  phone_number_rental
  sms_messages
  @@map("resource_type")
  @@schema("public")
}

enum SyncStatus {
  not_synced
  pending
  synced
  error
  @@map("sync_status")
  @@schema("public")
}

enum AgentDirection {
  inbound
  outbound
  @@map("agent_direction")
  @@schema("public")
}

enum PhoneNumberStatus {
  available
  assigned
  pending
  inactive
  error
  @@map("phone_number_status")
  @@schema("public")
}

enum PhoneNumberProvider {
  sip
  vapi
  retell
  twilio
  @@map("phone_number_provider")
  @@schema("public")
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  lost
  nurturing
  @@map("lead_status")
  @@schema("public")
}

enum LeadSource {
  voice_agent
  manual
  import
  api
  webhook
  @@map("lead_source")
  @@schema("public")
}

// =============================================================================
// WHITE-LABEL VARIANTS (Super Admin-managed plan tiers for agencies)
// =============================================================================

model WhiteLabelVariant {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug              String    @unique @db.VarChar(50)
  name              String    @db.VarChar(100)
  description       String?
  monthlyPriceCents Int       @default(0) @map("monthly_price_cents")
  stripeProductId   String?   @map("stripe_product_id") @db.VarChar(100)
  stripePriceId     String?   @map("stripe_price_id") @db.VarChar(100)
  maxWorkspaces     Int       @default(10) @map("max_workspaces") // -1 = unlimited
  isActive          Boolean   @default(true) @map("is_active")
  sortOrder         Int       @default(0) @map("sort_order")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partners        Partner[]
  partnerRequests PartnerRequest[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("white_label_variants")
  @@schema("public")
}

// =============================================================================
// PARTNER (Agency/Organization) - Top Level
// =============================================================================

model Partner {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  slug                   String    @unique
  branding               Json      @default("{}")
  // Partner tier: "platform" for main platform (billing exempt), "partner" for white-label agencies
  planTier               String    @default("partner") @map("plan_tier")
  features               Json      @default("{\"api_access\": true, \"white_label\": true, \"custom_domain\": true}")
  resourceLimits         Json      @default("{\"max_workspaces\": 10, \"max_users_per_workspace\": 50, \"max_agents_per_workspace\": 20}") @map("resource_limits")
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  subscriptionStatus     String    @default("active") @map("subscription_status")
  settings               Json      @default("{}")
  isPlatformPartner      Boolean   @default(false) @map("is_platform_partner")
  // If true, partner is exempt from platform billing (platform partner, custom arrangements)
  isBillingExempt        Boolean   @default(false) @map("is_billing_exempt")
  onboardingStatus       String?   @default("active") @map("onboarding_status")
  requestId              String?   @unique @map("request_id") @db.Uuid
  // Reference to the white-label variant (plan tier) this partner is subscribed to
  whiteLabelVariantId    String?   @map("white_label_variant_id") @db.Uuid
  deletedAt              DateTime? @map("deleted_at") @db.Timestamptz
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  domains                  PartnerDomain[]
  members                  PartnerMember[]
  workspaces               Workspace[]
  invitations              PartnerInvitation[]
  partnerRequest           PartnerRequest?     @relation("ProvisionedPartner")
  originatingRequest       PartnerRequest?     @relation("OriginatingRequest", fields: [requestId], references: [id])
  billingCredits           BillingCredits?
  subscriptionPlans        WorkspaceSubscriptionPlan[]
  whiteLabelVariant        WhiteLabelVariant?  @relation(fields: [whiteLabelVariantId], references: [id])
  integrations             PartnerIntegration[]
  sipTrunks                SipTrunk[]
  phoneNumbers             PhoneNumber[]
  googleCalendarCredential GoogleCalendarCredential?

  @@map("partners")
  @@schema("public")
}

// =============================================================================
// PARTNER DOMAINS (White-Label Hostname Mapping)
// =============================================================================

model PartnerDomain {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId         String    @map("partner_id") @db.Uuid
  hostname          String    @unique
  isPrimary         Boolean   @default(false) @map("is_primary")
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz
  verificationToken String?   @map("verification_token")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("partner_domains")
  @@schema("public")
}

// =============================================================================
// PARTNER MEMBERS (Users belonging to a Partner)
// =============================================================================

model PartnerMember {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId String    @map("partner_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  role      String    @default("member") // 'owner' | 'admin' | 'member'
  invitedBy String?   @map("invited_by") @db.Uuid
  joinedAt  DateTime? @default(now()) @map("joined_at") @db.Timestamptz
  removedAt DateTime? @map("removed_at") @db.Timestamptz
  removedBy String?   @map("removed_by") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([partnerId, userId])
  @@map("partner_members")
  @@schema("public")
}

// =============================================================================
// PARTNER INVITATIONS
// =============================================================================

model PartnerInvitation {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId  String    @map("partner_id") @db.Uuid
  email      String
  role       String    @default("member") // 'owner' | 'admin' | 'member'
  token      String    @unique @default(dbgenerated("encode(gen_random_bytes(32), 'hex'::text)"))
  message    String?
  invitedBy  String    @map("invited_by") @db.Uuid
  status     String    @default("pending") // 'pending' | 'accepted' | 'cancelled' | 'expired'
  expiresAt  DateTime  @default(dbgenerated("(now() + '7 days'::interval)")) @map("expires_at") @db.Timestamptz
  acceptedAt DateTime? @map("accepted_at") @db.Timestamptz
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  inviter User    @relation(fields: [invitedBy], references: [id])

  @@map("partner_invitations")
  @@schema("public")
}

// =============================================================================
// PARTNER REQUESTS (White-Label Onboarding)
// =============================================================================

model PartnerRequest {
  id                         String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status                     PartnerRequestStatus @default(pending)
  companyName                String               @map("company_name")
  contactEmail               String               @map("contact_email")
  contactName                String               @map("contact_name")
  phone                      String?
  desiredSubdomain           String               @map("desired_subdomain")
  customDomain               String               @map("custom_domain")
  businessDescription        String               @map("business_description")
  expectedUsers              Int?                 @map("expected_users")
  useCase                    String               @map("use_case")
  brandingData               Json                 @default("{}") @map("branding_data")
  selectedPlan               String               @default("enterprise") @map("selected_plan")
  billingInfo                Json?                @map("billing_info")
  requestedAt                DateTime             @default(now()) @map("requested_at") @db.Timestamptz
  reviewedAt                 DateTime?            @map("reviewed_at") @db.Timestamptz
  reviewedBy                 String?              @map("reviewed_by") @db.Uuid
  rejectionReason            String?              @map("rejection_reason")
  provisionedPartnerId       String?              @unique @map("provisioned_partner_id") @db.Uuid
  // Assigned white-label variant for this request (set by super admin before provisioning)
  assignedWhiteLabelVariantId String?             @map("assigned_white_label_variant_id") @db.Uuid
  metadata                   Json                 @default("{}")
  createdAt                  DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                  DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  provisionedPartner        Partner?           @relation("ProvisionedPartner", fields: [provisionedPartnerId], references: [id])
  originatingPartner        Partner?           @relation("OriginatingRequest")
  assignedWhiteLabelVariant WhiteLabelVariant? @relation(fields: [assignedWhiteLabelVariantId], references: [id])

  @@map("partner_requests")
  @@schema("public")
}

// =============================================================================
// WORKSPACES (Projects within a Partner)
// =============================================================================

model Workspace {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId           String    @map("partner_id") @db.Uuid
  name                String
  slug                String
  description         String?
  resourceLimits      Json      @default("{\"max_users\": 20, \"max_agents\": 10, \"max_minutes_per_month\": 1000}") @map("resource_limits")
  settings            Json      @default("{}")
  currentMonthMinutes Decimal   @default(0) @map("current_month_minutes") @db.Decimal
  currentMonthCost    Decimal   @default(0) @map("current_month_cost") @db.Decimal
  lastUsageResetAt    DateTime  @default(now()) @map("last_usage_reset_at") @db.Timestamptz
  status              String    @default("active")
  // Billing fields
  isBillingExempt     Boolean   @default(false) @map("is_billing_exempt")
  // Per-minute rate INHERITED from partner's billing_credits.perMinuteRateCents
  // This field is cached locally for query performance but is automatically synced via database trigger:
  // - On partner rate update: trigger_propagate_partner_rate automatically updates all workspaces
  // - On workspace creation: trigger_set_workspace_rate sets initial rate from partner
  // DO NOT update this directly - always update the partner's BillingCredits.perMinuteRateCents instead
  perMinuteRateCents  Int       @default(15) @map("per_minute_rate_cents") // Inherited from partner (default $0.15)
  deletedAt           DateTime? @map("deleted_at") @db.Timestamptz
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner                  Partner                          @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  members                  WorkspaceMember[]
  invitations              WorkspaceInvitation[]
  agents                   AiAgent[]
  conversations            Conversation[]
  usageTracking            UsageTracking[]
  integrations             WorkspaceIntegration[]           // ⚠️ DEPRECATED - Use integrationAssignments instead
  integrationAssignments   WorkspaceIntegrationAssignment[] // ✅ PREFERRED - Org-level key assignments
  knowledgeDocuments       KnowledgeDocument[]
  leads                    Lead[]
  workspaceCredits         WorkspaceCredits?
  subscription             WorkspaceSubscription?
  assignedPhoneNumbers     PhoneNumber[]

  @@unique([partnerId, slug])
  @@map("workspaces")
  @@schema("public")
}

// =============================================================================
// WORKSPACE MEMBERS
// =============================================================================

model WorkspaceMember {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  role        String    @default("member") // 'owner' | 'admin' | 'member' | 'viewer'
  invitedBy   String?   @map("invited_by") @db.Uuid
  invitedAt   DateTime? @map("invited_at") @db.Timestamptz
  joinedAt    DateTime? @default(now()) @map("joined_at") @db.Timestamptz
  removedAt   DateTime? @map("removed_at") @db.Timestamptz
  removedBy   String?   @map("removed_by") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
  @@schema("public")
}

// =============================================================================
// WORKSPACE INVITATIONS
// =============================================================================

model WorkspaceInvitation {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  email       String
  role        String    // 'admin' | 'member' | 'viewer'
  token       String    @unique @default(dbgenerated("encode(gen_random_bytes(32), 'hex'::text)"))
  message     String?
  invitedBy   String    @map("invited_by") @db.Uuid
  status      String    @default("pending") // 'pending' | 'accepted' | 'expired' | 'cancelled'
  expiresAt   DateTime  @default(dbgenerated("(now() + '7 days'::interval)")) @map("expires_at") @db.Timestamptz
  acceptedAt  DateTime? @map("accepted_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workspace_invitations")
  @@schema("public")
}

// =============================================================================
// WORKSPACE INTEGRATIONS (API Keys for Providers)
// ⚠️ DEPRECATED - Use PartnerIntegration + WorkspaceIntegrationAssignment instead
// =============================================================================
// 
// This model is being phased out. New integrations should use the org-level
// pattern where:
//   1. API keys are stored in `partner_integrations` at the organization level
//   2. Keys are assigned to workspaces via `workspace_integration_assignments`
//   3. This allows centralized key management and easier workspace provisioning
//
// Migration timeline:
//   - Current: Both models supported, org-level preferred
//   - 2026-06-01: Workspace-level model will be removed
//
// Migration path for existing workspace integrations:
//   1. Create org-level integration at /org/integrations with your API keys
//   2. Assign the integration to your workspace(s)
//   3. Remove the workspace-level integration
// =============================================================================

model WorkspaceIntegration {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  provider    String    @db.VarChar
  name        String    @db.VarChar
  apiKeys     Json      @default("{}") @map("api_keys")
  isActive    Boolean?  @default(true) @map("is_active")
  config      Json?     @default("{}")
  createdBy   String?   @map("created_by") @db.Uuid
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider])
  @@map("workspace_integrations")
  @@schema("public")
}

// =============================================================================
// PARTNER INTEGRATIONS (Org-Level API Keys for VAPI/Retell/Algolia)
// =============================================================================

model PartnerIntegration {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId   String    @map("partner_id") @db.Uuid
  provider    String    @db.VarChar(50) // 'vapi', 'retell', 'algolia'
  name        String    @db.VarChar(255) // Display name (e.g., "Production VAPI")
  apiKeys     Json      @default("{}") @map("api_keys") // { default_secret_key, default_public_key, additional_keys }
  config      Json?     @default("{}") // Provider-specific config
  isDefault   Boolean   @default(false) @map("is_default") // Auto-assigned to new workspaces
  isActive    Boolean   @default(true) @map("is_active")
  createdBy   String?   @map("created_by") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner     Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  creator     User?     @relation("IntegrationCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  assignments WorkspaceIntegrationAssignment[]

  @@index([partnerId])
  @@index([partnerId, provider])
  @@map("partner_integrations")
  @@schema("public")
}

// =============================================================================
// WORKSPACE INTEGRATION ASSIGNMENTS (Which key is assigned to which workspace)
// =============================================================================

model WorkspaceIntegrationAssignment {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId          String    @map("workspace_id") @db.Uuid
  provider             String    @db.VarChar(50) // 'vapi', 'retell', 'algolia'
  partnerIntegrationId String    @map("partner_integration_id") @db.Uuid
  assignedBy           String?   @map("assigned_by") @db.Uuid
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace          Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  partnerIntegration PartnerIntegration @relation(fields: [partnerIntegrationId], references: [id], onDelete: Cascade)
  assigner           User?              @relation("AssignmentAssigner", fields: [assignedBy], references: [id], onDelete: SetNull)

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@index([partnerIntegrationId])
  @@map("workspace_integration_assignments")
  @@schema("public")
}

// =============================================================================
// AI AGENTS
// =============================================================================

model AiAgent {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId           String?             @map("workspace_id") @db.Uuid
  name                  String
  description           String?
  provider              AgentProvider
  voiceProvider         VoiceProvider?      @map("voice_provider")
  modelProvider         ModelProvider?      @map("model_provider")
  transcriberProvider   TranscriberProvider? @map("transcriber_provider")
  config                Json                @default("{}")
  agentSecretApiKey     Json[]              @default([]) @map("agent_secret_api_key")
  agentPublicApiKey     Json[]              @default([]) @map("agent_public_api_key")
  externalAgentId       String?             @map("external_agent_id")
  externalPhoneNumber   String?             @map("external_phone_number")
  retellLlmId           String?             @map("retell_llm_id")
  isActive              Boolean             @default(true) @map("is_active")
  version               Int                 @default(1)
  tags                  String[]            @default([])
  totalConversations    Int                 @default(0) @map("total_conversations")
  totalMinutes          Decimal             @default(0) @map("total_minutes") @db.Decimal
  totalCost             Decimal             @default(0) @map("total_cost") @db.Decimal
  lastConversationAt    DateTime?           @map("last_conversation_at") @db.Timestamptz
  // Sync columns
  needsResync           Boolean             @default(false) @map("needs_resync")
  syncStatus            String              @default("not_synced") @map("sync_status") @db.VarChar(20)
  lastSyncedAt          DateTime?           @map("last_synced_at") @db.Timestamptz
  lastSyncError         String?             @map("last_sync_error")
  // Direction/Telephony columns
  agentDirection        AgentDirection      @default(inbound) @map("agent_direction")
  allowOutbound         Boolean             @default(false) @map("allow_outbound")
  assignedPhoneNumberId String?             @map("assigned_phone_number_id") @db.Uuid
  // Audit
  createdBy             String?             @map("created_by") @db.Uuid
  deletedAt             DateTime?           @map("deleted_at") @db.Timestamptz
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace            Workspace?               @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  creator              User?                    @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  assignedPhoneNumber  PhoneNumber?             @relation("AgentPhoneNumber", fields: [assignedPhoneNumberId], references: [id], onDelete: SetNull)
  conversations        Conversation[]
  leads                Lead[]
  knowledgeDocuments   AgentKnowledgeDocument[]
  assignedPhoneNumbers PhoneNumber[]            @relation("PhoneNumberAgent")
  calendarConfig       AgentCalendarConfig?
  appointments         Appointment[]

  @@index([assignedPhoneNumberId])
  @@map("ai_agents")
  @@schema("public")
}

// =============================================================================
// CONVERSATIONS (Call Records)
// =============================================================================

model Conversation {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId      String?       @map("workspace_id") @db.Uuid
  agentId          String?       @map("agent_id") @db.Uuid
  externalId       String?       @map("external_id")
  direction        CallDirection
  status           CallStatus    @default(initiated)
  phoneNumber      String?       @map("phone_number")
  callerName       String?       @map("caller_name")
  startedAt        DateTime?     @map("started_at") @db.Timestamptz
  endedAt          DateTime?     @map("ended_at") @db.Timestamptz
  durationSeconds  Int           @default(0) @map("duration_seconds")
  recordingUrl     String?       @map("recording_url")
  transcript       String?
  transcriptSearch Unsupported("tsvector")? @map("transcript_search")
  summary          String?
  sentiment        String?
  qualityScore     Decimal?      @map("quality_score") @db.Decimal
  customerRating   Int?          @map("customer_rating")
  // Total cost from provider (VAPI/Retell) - stored for internal tracking only
  totalCost        Decimal       @default(0) @map("total_cost") @db.Decimal
  // Cost breakdown JSON structure:
  // {
  //   provider_cost_cents: number,     // Original cost from VAPI/Retell (internal only)
  //   partner_cost_cents: number,      // Calculated: minutes * partner_rate (displayed to users)
  //   duration_minutes: number,        // Call duration used for calculation
  //   partner_rate_cents: number,      // Partner rate at time of call
  //   ... provider-specific breakdown fields
  // }
  costBreakdown    Json          @default("{}") @map("cost_breakdown")
  requiresFollowUp Boolean       @default(false) @map("requires_follow_up")
  followUpNotes    String?       @map("follow_up_notes")
  followedUpAt     DateTime?     @map("followed_up_at") @db.Timestamptz
  followedUpBy     String?       @map("followed_up_by") @db.Uuid
  errorMessage     String?       @map("error_message")
  errorCode        String?       @map("error_code")
  metadata         Json          @default("{}")
  deletedAt        DateTime?     @map("deleted_at") @db.Timestamptz
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace     Workspace?      @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  agent         AiAgent?        @relation(fields: [agentId], references: [id], onDelete: SetNull)
  followUpUser  User?           @relation(fields: [followedUpBy], references: [id], onDelete: SetNull)
  usageTracking UsageTracking[]
  appointments  Appointment[]

  @@map("conversations")
  @@schema("public")
}

// =============================================================================
// USAGE TRACKING
// =============================================================================

model UsageTracking {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId      String?      @map("workspace_id") @db.Uuid
  conversationId   String?      @map("conversation_id") @db.Uuid
  resourceType     ResourceType @map("resource_type")
  resourceProvider String?      @map("resource_provider")
  quantity         Decimal      @db.Decimal
  unit             String?
  unitCost         Decimal?     @map("unit_cost") @db.Decimal
  totalCost        Decimal?     @map("total_cost") @db.Decimal
  billingPeriod    String?      @map("billing_period")
  isBillable       Boolean      @default(true) @map("is_billable")
  invoiceId        String?      @map("invoice_id")
  metadata         Json         @default("{}")
  recordedAt       DateTime     @default(now()) @map("recorded_at") @db.Timestamptz
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace    Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@map("usage_tracking")
  @@schema("public")
}

// =============================================================================
// USERS (Public Profile - Linked to Supabase Auth)
// =============================================================================

model User {
  id             String     @id @db.Uuid // References auth.users(id)
  email          String
  firstName      String?    @map("first_name")
  lastName       String?    @map("last_name")
  avatarUrl      String?    @map("avatar_url")
  phoneNumber    String?    @map("phone_number")
  role           UserRole   @default(org_member)
  status         UserStatus @default(active)
  settings       Json       @default("{}")
  lastLoginAt    DateTime?  @map("last_login_at") @db.Timestamptz
  lastActivityAt DateTime?  @map("last_activity_at") @db.Timestamptz
  deletedAt      DateTime?  @map("deleted_at") @db.Timestamptz
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partnerMembers          PartnerMember[]
  partnerInvitations      PartnerInvitation[]
  createdAgents           AiAgent[]
  followedUpConversations Conversation[]
  createdDocuments        KnowledgeDocument[] @relation("DocumentCreator")
  updatedDocuments        KnowledgeDocument[] @relation("DocumentUpdater")
  assignedLeads           Lead[]              @relation("AssignedLeads")
  createdLeads            Lead[]              @relation("CreatedLeads")
  createdIntegrations     PartnerIntegration[] @relation("IntegrationCreator")
  assignedIntegrations    WorkspaceIntegrationAssignment[] @relation("AssignmentAssigner")
  createdSipTrunks        SipTrunk[]          @relation("SipTrunkCreator")
  createdPhoneNumbers     PhoneNumber[]       @relation("PhoneNumberCreator")

  @@map("users")
  @@schema("public")
}

// =============================================================================
// SUPER ADMIN
// =============================================================================

model SuperAdmin {
  id          String    @id @db.Uuid // References auth.users(id)
  email       String    @unique
  firstName   String?   @map("first_name")
  lastName    String?   @map("last_name")
  avatarUrl   String?   @map("avatar_url")
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("super_admin")
  @@schema("public")
}

// =============================================================================
// KNOWLEDGE DOCUMENTS
// =============================================================================

enum KnowledgeDocumentType {
  document
  faq
  product_info
  policy
  script
  other

  @@map("knowledge_document_type")
  @@schema("public")
}

enum KnowledgeDocumentStatus {
  draft
  processing
  active
  archived
  error

  @@map("knowledge_document_status")
  @@schema("public")
}

model KnowledgeDocument {
  id            String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId   String                   @map("workspace_id") @db.Uuid
  
  // Document metadata
  title         String                   @db.VarChar(500)
  description   String?
  documentType  KnowledgeDocumentType    @default(document) @map("document_type")
  status        KnowledgeDocumentStatus  @default(draft)
  
  // Content
  content       String?
  
  // File upload info
  fileName      String?                  @map("file_name") @db.VarChar(500)
  fileUrl       String?                  @map("file_url")
  fileType      String?                  @map("file_type") @db.VarChar(100)
  fileSizeBytes BigInt?                  @map("file_size_bytes")
  
  // Categorization
  tags          String[]                 @default([])
  category      String?                  @db.VarChar(255)
  
  // Vector search
  contentHash      String?               @map("content_hash") @db.VarChar(64)
  embeddingStatus  String?               @default("pending") @map("embedding_status") @db.VarChar(20)
  
  // Usage tracking
  usageCount    Int                      @default(0) @map("usage_count")
  lastUsedAt    DateTime?                @map("last_used_at") @db.Timestamptz
  
  // Audit fields
  createdBy     String?                  @map("created_by") @db.Uuid
  updatedBy     String?                  @map("updated_by") @db.Uuid
  deletedAt     DateTime?                @map("deleted_at") @db.Timestamptz
  createdAt     DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace     Workspace                @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator       User?                    @relation("DocumentCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater       User?                    @relation("DocumentUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  agents        AgentKnowledgeDocument[]

  @@map("knowledge_documents")
  @@schema("public")
}

// =============================================================================
// AGENT KNOWLEDGE DOCUMENTS (Junction table for many-to-many)
// =============================================================================

model AgentKnowledgeDocument {
  id                  String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId             String            @map("agent_id") @db.Uuid
  knowledgeDocumentId String            @map("knowledge_document_id") @db.Uuid
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  agent             AiAgent           @relation(fields: [agentId], references: [id], onDelete: Cascade)
  knowledgeDocument KnowledgeDocument @relation(fields: [knowledgeDocumentId], references: [id], onDelete: Cascade)

  @@unique([agentId, knowledgeDocumentId])
  @@index([agentId])
  @@index([knowledgeDocumentId])
  @@map("agent_knowledge_documents")
  @@schema("public")
}

// =============================================================================
// LEADS
// =============================================================================

model Lead {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId      String      @map("workspace_id") @db.Uuid

  // Contact information
  firstName        String?     @map("first_name") @db.VarChar(255)
  lastName         String?     @map("last_name") @db.VarChar(255)
  email            String?     @db.VarChar(255)
  phone            String?     @db.VarChar(50)
  company          String?     @db.VarChar(255)
  jobTitle         String?     @map("job_title") @db.VarChar(255)

  // Lead management
  status           LeadStatus  @default(new)
  source           LeadSource  @default(manual)
  priority         Int         @default(0) // 0=low, 1=medium, 2=high
  score            Int         @default(0) // Lead score (0-100)

  // Related entities
  agentId          String?     @map("agent_id") @db.Uuid
  conversationId   String?     @map("conversation_id") @db.Uuid
  assignedTo       String?     @map("assigned_to") @db.Uuid

  // Additional info
  notes            String?
  tags             String[]    @default([])
  customFields     Json        @default("{}") @map("custom_fields")

  // Engagement tracking
  lastContactedAt  DateTime?   @map("last_contacted_at") @db.Timestamptz
  nextFollowUpAt   DateTime?   @map("next_follow_up_at") @db.Timestamptz

  // Audit fields
  createdBy        String?     @map("created_by") @db.Uuid
  deletedAt        DateTime?   @map("deleted_at") @db.Timestamptz
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace        Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  agent            AiAgent?    @relation(fields: [agentId], references: [id], onDelete: SetNull)
  assignee         User?       @relation("AssignedLeads", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator          User?       @relation("CreatedLeads", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([status])
  @@index([email])
  @@index([phone])
  @@index([createdAt])
  @@map("leads")
  @@schema("public")
}

// =============================================================================
// SIP TRUNKS (Partner-level telephony configuration)
// =============================================================================

model SipTrunk {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId            String    @map("partner_id") @db.Uuid
  
  // Display
  name                 String    @db.VarChar(255)
  description          String?
  
  // SIP Server Configuration
  sipServer            String    @map("sip_server") @db.VarChar(255)
  sipPort              Int       @default(5060) @map("sip_port")
  sipTransport         String    @default("udp") @map("sip_transport") @db.VarChar(10)
  
  // Authentication
  sipUsername          String    @map("sip_username") @db.VarChar(255)
  sipPassword          String    @map("sip_password")
  sipRealm             String?   @map("sip_realm") @db.VarChar(255)
  
  // Registration
  register             Boolean   @default(true)
  registrationExpiry   Int       @default(3600) @map("registration_expiry")
  
  // Outbound
  outboundProxy        String?   @map("outbound_proxy") @db.VarChar(255)
  outboundCallerId     String?   @map("outbound_caller_id") @db.VarChar(50)
  
  // Status
  isActive             Boolean   @default(true) @map("is_active")
  isDefault            Boolean   @default(false) @map("is_default")
  lastRegistrationAt   DateTime? @map("last_registration_at") @db.Timestamptz
  registrationStatus   String?   @map("registration_status") @db.VarChar(50)
  registrationError    String?   @map("registration_error")
  
  // Provider integration
  provider             String?   @db.VarChar(50)
  externalCredentialId String?   @map("external_credential_id") @db.VarChar(255)
  
  // Configuration
  config               Json      @default("{}")
  
  // Audit
  createdBy            String?   @map("created_by") @db.Uuid
  deletedAt            DateTime? @map("deleted_at") @db.Timestamptz
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner              Partner        @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  creator              User?          @relation("SipTrunkCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  phoneNumbers         PhoneNumber[]

  @@index([partnerId])
  @@index([isActive])
  @@map("sip_trunks")
  @@schema("public")
}

// =============================================================================
// PHONE NUMBERS (Partner-level phone number inventory)
// =============================================================================

model PhoneNumber {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId            String              @map("partner_id") @db.Uuid
  
  // Phone number details
  phoneNumber          String              @map("phone_number") @db.VarChar(50)
  phoneNumberE164      String?             @map("phone_number_e164") @db.VarChar(20)
  friendlyName         String?             @map("friendly_name") @db.VarChar(255)
  description          String?
  countryCode          String?             @map("country_code") @db.VarChar(5)
  
  // Provider information
  provider             PhoneNumberProvider @default(sip)
  externalId           String?             @map("external_id") @db.VarChar(255)
  
  // SIP configuration
  sipUri               String?             @map("sip_uri") @db.VarChar(500)
  sipTrunkId           String?             @map("sip_trunk_id") @db.VarChar(255)
  sipTrunkIdRef        String?             @map("sip_trunk_id_ref") @db.Uuid
  
  // Assignment
  status               PhoneNumberStatus   @default(available)
  assignedAgentId      String?             @map("assigned_agent_id") @db.Uuid
  assignedWorkspaceId  String?             @map("assigned_workspace_id") @db.Uuid
  assignedAt           DateTime?           @map("assigned_at") @db.Timestamptz
  
  // Capabilities
  supportsInbound      Boolean             @default(true) @map("supports_inbound")
  supportsOutbound     Boolean             @default(true) @map("supports_outbound")
  supportsSms          Boolean             @default(false) @map("supports_sms")
  
  // Configuration
  config               Json                @default("{}")
  
  // Audit
  createdBy            String?             @map("created_by") @db.Uuid
  deletedAt            DateTime?           @map("deleted_at") @db.Timestamptz
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner              Partner             @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  sipTrunk             SipTrunk?           @relation(fields: [sipTrunkIdRef], references: [id], onDelete: SetNull)
  assignedAgent        AiAgent?            @relation("PhoneNumberAgent", fields: [assignedAgentId], references: [id], onDelete: SetNull)
  assignedWorkspace    Workspace?          @relation(fields: [assignedWorkspaceId], references: [id], onDelete: SetNull)
  creator              User?               @relation("PhoneNumberCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  agentsWithThisNumber AiAgent[]           @relation("AgentPhoneNumber")

  @@index([partnerId])
  @@index([status])
  @@index([assignedAgentId])
  @@index([assignedWorkspaceId])
  @@unique([partnerId, phoneNumber])
  @@map("phone_numbers")
  @@schema("public")
}

// =============================================================================
// GOOGLE CALENDAR CREDENTIALS (Partner/Organization Level)
// =============================================================================

model GoogleCalendarCredential {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId       String    @map("partner_id") @db.Uuid
  
  // OAuth Credentials
  clientId        String    @map("client_id") @db.VarChar(255)
  clientSecret    String    @map("client_secret") // Encrypted
  refreshToken    String?   @map("refresh_token") // Encrypted
  accessToken     String?   @map("access_token") // Encrypted
  tokenExpiry     DateTime? @map("token_expiry") @db.Timestamptz
  
  // Scopes granted
  scopes          String[]  @default([])
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  lastUsedAt      DateTime? @map("last_used_at") @db.Timestamptz
  lastError       String?   @map("last_error")
  
  // Audit
  createdBy       String?   @map("created_by") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner         Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  agentCalendars  AgentCalendarConfig[]

  @@unique([partnerId])
  @@index([partnerId])
  @@map("google_calendar_credentials")
  @@schema("public")
}

// =============================================================================
// AGENT CALENDAR CONFIGURATION
// =============================================================================

model AgentCalendarConfig {
  id                          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId                     String    @unique @map("agent_id") @db.Uuid
  workspaceId                 String    @map("workspace_id") @db.Uuid
  
  // Google Calendar Settings
  googleCredentialId          String    @map("google_credential_id") @db.Uuid
  calendarId                  String    @map("calendar_id") @db.VarChar(255) // Google Calendar ID
  calendarName                String?   @map("calendar_name") @db.VarChar(500) // Human-readable name: workspacename-agentname
  
  // Timezone (REQUIRED)
  timezone                    String    @db.VarChar(100) // IANA timezone (e.g., "America/New_York")
  
  // Slot Configuration
  slotDurationMinutes         Int       @default(30) @map("slot_duration_minutes")
  bufferBetweenSlotsMinutes   Int       @default(0) @map("buffer_between_slots_minutes")
  
  // Availability Windows (JSON: { days: string[], hours: { start: string, end: string } })
  preferredDays               String[]  @default(["monday", "tuesday", "wednesday", "thursday", "friday"]) @map("preferred_days")
  preferredHoursStart         String    @default("09:00") @map("preferred_hours_start") @db.VarChar(5)
  preferredHoursEnd           String    @default("17:00") @map("preferred_hours_end") @db.VarChar(5)
  
  // Booking Rules
  minNoticeHours              Int       @default(24) @map("min_notice_hours")
  maxAdvanceDays              Int       @default(30) @map("max_advance_days")
  
  // Reminder Settings (Legacy)
  send24hReminder             Boolean   @default(true) @map("send_24h_reminder")
  send1hReminder              Boolean   @default(true) @map("send_1h_reminder")
  reminderEmailTemplate       String?   @map("reminder_email_template")
  
  // Email Notification Settings
  enableOwnerEmail            Boolean   @default(false) @map("enable_owner_email")
  ownerEmail                  String?   @map("owner_email") @db.VarChar(255)
  
  // Dynamic Reminder Settings
  enableReminders             Boolean   @default(false) @map("enable_reminders")
  reminders                   Json      @default("[]")
  
  // Status
  isActive                    Boolean   @default(true) @map("is_active")
  
  // Audit
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  agent                       AiAgent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  googleCredential            GoogleCalendarCredential @relation(fields: [googleCredentialId], references: [id], onDelete: Cascade)
  appointments                Appointment[]

  @@index([agentId])
  @@index([workspaceId])
  @@map("agent_calendar_configs")
  @@schema("public")
}

// =============================================================================
// APPOINTMENTS
// =============================================================================

enum AppointmentStatus {
  scheduled
  cancelled
  rescheduled
  completed
  no_show

  @@map("appointment_status")
  @@schema("public")
}

enum AppointmentType {
  book
  reschedule
  cancel

  @@map("appointment_type")
  @@schema("public")
}

model Appointment {
  id                      String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId                 String            @map("agent_id") @db.Uuid
  workspaceId             String            @map("workspace_id") @db.Uuid
  calendarConfigId        String            @map("calendar_config_id") @db.Uuid
  conversationId          String?           @map("conversation_id") @db.Uuid
  
  // Google Calendar Reference
  googleEventId           String?           @map("google_event_id") @db.VarChar(255)
  calendarId              String            @map("calendar_id") @db.VarChar(255)
  
  // Attendee Information
  attendeeName            String            @map("attendee_name") @db.VarChar(255)
  attendeeEmail           String            @map("attendee_email") @db.VarChar(255)
  attendeePhone           String?           @map("attendee_phone") @db.VarChar(50)
  
  // Appointment Details
  appointmentType         AppointmentType   @map("appointment_type")
  status                  AppointmentStatus @default(scheduled)
  
  // Timing
  scheduledStart          DateTime          @map("scheduled_start") @db.Timestamptz
  scheduledEnd            DateTime          @map("scheduled_end") @db.Timestamptz
  timezone                String            @db.VarChar(100)
  durationMinutes         Int               @map("duration_minutes")
  
  // Rescheduling History
  originalAppointmentId   String?           @map("original_appointment_id") @db.Uuid
  rescheduledFrom         DateTime?         @map("rescheduled_from") @db.Timestamptz
  rescheduledTo           DateTime?         @map("rescheduled_to") @db.Timestamptz
  
  // Cancellation Info
  cancelledAt             DateTime?         @map("cancelled_at") @db.Timestamptz
  cancellationReason      String?           @map("cancellation_reason")
  
  // Reminder Tracking
  reminder24hSent         Boolean           @default(false) @map("reminder_24h_sent")
  reminder24hSentAt       DateTime?         @map("reminder_24h_sent_at") @db.Timestamptz
  reminder1hSent          Boolean           @default(false) @map("reminder_1h_sent")
  reminder1hSentAt        DateTime?         @map("reminder_1h_sent_at") @db.Timestamptz
  
  // Metadata
  notes                   String?
  customFields            Json              @default("{}") @map("custom_fields")
  extractedFromTranscript Boolean           @default(false) @map("extracted_from_transcript")
  
  // Audit
  createdAt               DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  agent                   AiAgent           @relation(fields: [agentId], references: [id], onDelete: Cascade)
  calendarConfig          AgentCalendarConfig @relation(fields: [calendarConfigId], references: [id], onDelete: Cascade)
  conversation            Conversation?     @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  originalAppointment     Appointment?      @relation("RescheduledAppointments", fields: [originalAppointmentId], references: [id], onDelete: SetNull)
  rescheduledAppointments Appointment[]     @relation("RescheduledAppointments")

  @@index([agentId])
  @@index([workspaceId])
  @@index([attendeeEmail])
  @@index([status])
  @@index([scheduledStart])
  @@index([googleEventId])
  @@map("appointments")
  @@schema("public")
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuditLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  partnerId   String?   @map("partner_id") @db.Uuid
  workspaceId String?   @map("workspace_id") @db.Uuid
  action      String
  entityType  String    @map("entity_type")
  entityId    String?   @map("entity_id") @db.Uuid
  oldValues   Json?     @map("old_values")
  newValues   Json?     @map("new_values")
  metadata    Json?
  ipAddress   String?   @map("ip_address") @db.Inet
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId])
  @@index([partnerId])
  @@index([workspaceId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_log")
  @@schema("public")
}

// =============================================================================
// BILLING CREDITS (Partner-level usage credits)
// =============================================================================

enum CreditTransactionType {
  topup
  usage
  refund
  adjustment
  @@map("credit_transaction_type")
  @@schema("public")
}

model BillingCredits {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId                String   @unique @map("partner_id") @db.Uuid
  balanceCents             Int      @default(0) @map("balance_cents")
  lowBalanceThresholdCents Int      @default(1000) @map("low_balance_threshold_cents") // $10 default
  // Partner-level per-minute rate (CANONICAL PRICING RATE)
  // This is the single source of truth for pricing that applies to ALL workspaces under this partner.
  // - Used for billing calculations and cost display
  // - Hides provider costs from workspaces (they only see partner rate)
  // - Automatically propagated to workspaces via database trigger
  perMinuteRateCents       Int      @default(15) @map("per_minute_rate_cents") // $0.15 default
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner      Partner             @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  transactions CreditTransaction[]

  @@map("billing_credits")
  @@schema("public")
}

model CreditTransaction {
  id                    String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  billingCreditsId      String                @map("billing_credits_id") @db.Uuid
  type                  CreditTransactionType
  amountCents           Int                   @map("amount_cents") // Positive for credits, negative for debits
  balanceAfterCents     Int                   @map("balance_after_cents")
  description           String?
  metadata              Json                  @default("{}")
  stripePaymentIntentId String?               @map("stripe_payment_intent_id")
  conversationId        String?               @map("conversation_id") @db.Uuid
  createdAt             DateTime              @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  billingCredits BillingCredits @relation(fields: [billingCreditsId], references: [id], onDelete: Cascade)

  @@index([billingCreditsId])
  @@index([type])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("credit_transactions")
  @@schema("public")
}

// =============================================================================
// WORKSPACE BILLING CREDITS (Workspace-level usage credits)
// =============================================================================

model WorkspaceCredits {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId              String   @unique @map("workspace_id") @db.Uuid
  balanceCents             Int      @default(0) @map("balance_cents")
  lowBalanceThresholdCents Int      @default(500) @map("low_balance_threshold_cents") // $5 default
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace    Workspace                    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  transactions WorkspaceCreditTransaction[]

  @@map("workspace_credits")
  @@schema("public")
}

model WorkspaceCreditTransaction {
  id                    String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceCreditsId    String                @map("workspace_credits_id") @db.Uuid
  type                  CreditTransactionType
  amountCents           Int                   @map("amount_cents") // Positive for credits, negative for debits
  balanceAfterCents     Int                   @map("balance_after_cents")
  description           String?
  metadata              Json                  @default("{}")
  stripePaymentIntentId String?               @map("stripe_payment_intent_id")
  conversationId        String?               @map("conversation_id") @db.Uuid
  createdAt             DateTime              @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspaceCredits WorkspaceCredits @relation(fields: [workspaceCreditsId], references: [id], onDelete: Cascade)

  @@index([workspaceCreditsId])
  @@index([type])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("workspace_credit_transactions")
  @@schema("public")
}

// =============================================================================
// WORKSPACE SUBSCRIPTION PLANS (Partner-defined plans for workspaces)
// =============================================================================

enum WorkspaceSubscriptionStatus {
  active
  past_due
  canceled
  incomplete
  trialing
  paused

  @@map("workspace_subscription_status")
  @@schema("public")
}

enum BillingType {
  prepaid
  postpaid

  @@map("billing_type")
  @@schema("public")
}

model WorkspaceSubscriptionPlan {
  id                       String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnerId                String      @map("partner_id") @db.Uuid
  name                     String      @db.VarChar(100)
  slug                     String?     @db.VarChar(50) // URL-friendly identifier (e.g., "free", "starter")
  description              String?
  stripeProductId          String?     @map("stripe_product_id") @db.VarChar(100)
  stripePriceId            String?     @map("stripe_price_id") @db.VarChar(100)
  monthlyPriceCents        Int         @default(0) @map("monthly_price_cents")
  includedMinutes          Int         @default(0) @map("included_minutes")
  overageRateCents         Int         @default(20) @map("overage_rate_cents") // $0.20/min default
  features                 Json        @default("[]")
  maxAgents                Int?        @map("max_agents")
  maxConversationsPerMonth Int?        @map("max_conversations_per_month")
  // Billing type configuration
  billingType              BillingType @default(prepaid) @map("billing_type")
  postpaidMinutesLimit     Int?        @map("postpaid_minutes_limit") // Max minutes before blocking (postpaid only)
  isActive                 Boolean     @default(true) @map("is_active")
  isPublic                 Boolean     @default(true) @map("is_public")
  // If true, this is a default platform plan (available to all partners as template)
  isDefault                Boolean     @default(false) @map("is_default")
  sortOrder                Int         @default(0) @map("sort_order")
  createdAt                DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  partner       Partner                 @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  subscriptions WorkspaceSubscription[]

  @@unique([partnerId, slug])
  @@index([partnerId])
  @@index([partnerId, isActive])
  @@index([isDefault])
  @@map("workspace_subscription_plans")
  @@schema("public")
}

// =============================================================================
// WORKSPACE SUBSCRIPTIONS (Workspace subscribing to a Partner's plan)
// =============================================================================

model WorkspaceSubscription {
  id                        String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId               String                      @unique @map("workspace_id") @db.Uuid
  planId                    String                      @map("plan_id") @db.Uuid
  stripeSubscriptionId      String?                     @map("stripe_subscription_id") @db.VarChar(100)
  stripeCustomerId          String?                     @map("stripe_customer_id") @db.VarChar(100)
  status                    WorkspaceSubscriptionStatus @default(incomplete)
  currentPeriodStart        DateTime?                   @map("current_period_start") @db.Timestamptz
  currentPeriodEnd          DateTime?                   @map("current_period_end") @db.Timestamptz
  minutesUsedThisPeriod     Int                         @default(0) @map("minutes_used_this_period")
  overageChargesCents       Int                         @default(0) @map("overage_charges_cents")
  // Postpaid billing fields
  postpaidMinutesUsed       Int                         @default(0) @map("postpaid_minutes_used") // Usage in current period
  pendingInvoiceAmountCents Int                         @default(0) @map("pending_invoice_amount_cents") // Accumulated charges
  cancelAtPeriodEnd         Boolean                     @default(false) @map("cancel_at_period_end")
  canceledAt                DateTime?                   @map("canceled_at") @db.Timestamptz
  trialStart                DateTime?                   @map("trial_start") @db.Timestamptz
  trialEnd                  DateTime?                   @map("trial_end") @db.Timestamptz
  createdAt                 DateTime                    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime                    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace Workspace                 @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  plan      WorkspaceSubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([workspaceId])
  @@index([planId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("workspace_subscriptions")
  @@schema("public")
}

