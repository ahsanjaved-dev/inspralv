---
name: Phase 1 Agency Onboarding
overview: Transform the platform into an industry-standard multi-tenant SaaS with professional agency onboarding, white-label partner request system, and super admin approval workflow. This includes creating a marketing page with plan selection, comprehensive partner request forms, email notifications via Resend, and a robust super admin approval dashboard.
todos:
  - id: database-schema
    content: Create partner_requests table and update partners table schema
    status: pending
  - id: marketing-pages
    content: Build marketing layout, homepage, and pricing page
    status: pending
  - id: partner-request-form
    content: Create multi-step partner request form with validation
    status: pending
  - id: api-partner-requests
    content: Build API routes for partner request submission and subdomain check
    status: pending
  - id: super-admin-apis
    content: Create super admin APIs for request management and provisioning
    status: pending
  - id: email-templates
    content: Design and implement Resend email templates for all notifications
    status: pending
  - id: super-admin-dashboard
    content: Build partner requests dashboard and detail pages in super admin
    status: pending
  - id: react-hooks
    content: Create React Query hooks for partner request management
    status: pending
  - id: ui-components
    content: Build reusable components for pricing cards and request management
    status: pending
  - id: customer-flow
    content: Update customer signup and onboarding flow with plan selection
    status: pending
  - id: testing
    content: Test complete flow from request submission to partner provisioning
    status: pending
---

# Phase 1: Professional Agency Onboarding & White-Label Request System

## Architecture Overview

```mermaid
flowchart TD
    MarketingPage[Marketing Page] --> PlanSelection{Plan Selection}
    PlanSelection -->|Starter/Pro| CustomerSignup[Customer Signup]
    PlanSelection -->|Enterprise/WhiteLabel| PartnerRequest[Partner Request Form]
    
    CustomerSignup --> PlatformPartner[Platform Partner Member]
    PlatformPartner --> CreateWorkspace[Create Workspace]
    
    PartnerRequest --> RequestDB[(Partner Requests DB)]
    RequestDB --> EmailNotification[Email to Super Admin]
    EmailNotification --> SuperAdminDashboard[Super Admin Dashboard]
    
    SuperAdminDashboard --> ReviewRequest{Review Request}
    ReviewRequest -->|Approve| ProvisionPartner[Provision Partner]
    ReviewRequest -->|Reject| SendRejectionEmail[Send Rejection Email]
    
    ProvisionPartner --> CreatePartnerRecord[Create Partner Record]
    CreatePartnerRecord --> SetupDomain[Setup Custom Domain]
    SetupDomain --> CreateOwnerAccount[Create Owner Account]
    CreateOwnerAccount --> SendWelcomeEmail[Send Welcome Email]
    SendWelcomeEmail --> PartnerActive[Partner Active]
```

## Implementation Plan

### 1. Database Schema Updates

**Create new table: `partner_requests`**

- `id` (uuid, primary key)
- `status` (enum: 'pending', 'approved', 'rejected', 'provisioning')
- `company_name` (text)
- `contact_email` (text)
- `contact_name` (text)
- `phone` (text, optional)
- `desired_subdomain` (text)
- `custom_domain` (text, optional)
- `business_description` (text)
- `expected_users` (integer)
- `use_case` (text)
- `branding_data` (jsonb: logo_url, primary_color, secondary_color)
- `selected_plan` (text: 'enterprise')
- `billing_info` (jsonb, optional)
- `requested_at` (timestamp)
- `reviewed_at` (timestamp, nullable)
- `reviewed_by` (uuid, nullable, FK to super_admins)
- `rejection_reason` (text, nullable)
- `provisioned_partner_id` (uuid, nullable, FK to partners)
- `metadata` (jsonb)

**Add to `partners` table:**

- `onboarding_status` (enum: 'active', 'provisioning', 'suspended')
- `request_id` (uuid, nullable, FK to partner_requests)

### 2. Marketing & Landing Pages

**Create: [`app/(marketing)/pricing/page.tsx`](app/\(marketing)/pricing/page.tsx)**

- Beautiful pricing cards for 3 tiers
- Starter ($79/mo): 5 agents, 1000 min/month, platform partner
- Professional ($249/mo): 25 agents, 5000 min/month, platform partner
- Enterprise (Custom): "Request White-Label" CTA button
- Feature comparison table
- FAQ section

**Create: [`app/(marketing)/request-partner/page.tsx`](app/\(marketing)/request-partner/page.tsx)**

- Multi-step form (3 steps):
  - Step 1: Company & Contact Info
  - Step 2: Business Details & Requirements
  - Step 3: Branding & Technical Setup
- Form validation with Zod
- File upload for logo (store in Supabase Storage)
- Color picker for branding
- Subdomain availability checker (real-time)
- Custom domain input (optional)
- Success page with "Request Submitted" message

**Create: [`app/(marketing)/layout.tsx`](app/\(marketing)/layout.tsx)**

- Marketing site layout with header/footer
- Different from authenticated app layout
- Navigation: Home, Pricing, Features, Contact

### 3. API Routes for Partner Requests

**Create: [`app/api/partner-requests/route.ts`](app/api/partner-requests/route.ts)**

- `POST /api/partner-requests` - Submit new partner request
  - Validate all fields with Zod schema
  - Check subdomain availability
  - Upload logo to Supabase Storage if provided
  - Insert into `partner_requests` table with status 'pending'
  - Send email notification to super admin
  - Return success with request ID

**Create: [`app/api/partner-requests/check-subdomain/route.ts`](app/api/partner-requests/check-subdomain/route.ts)**

- `GET /api/partner-requests/check-subdomain?subdomain=xyz`
  - Check if subdomain is available
  - Check against existing partners and partner_domains
  - Return { available: boolean }

**Create: [`app/api/super-admin/partner-requests/route.ts`](app/api/super-admin/partner-requests/route.ts)**

- `GET /api/super-admin/partner-requests` - List all requests with filters
  - Query params: status, search, page, pageSize
  - Return paginated results with counts

**Create: [`app/api/super-admin/partner-requests/[id]/route.ts`](app/api/super-admin/partner-requests/[id]/route.ts)**

- `GET /api/super-admin/partner-requests/[id]` - Get single request details
- `PATCH /api/super-admin/partner-requests/[id]` - Update request (approve/reject)
  - On approve: Trigger provisioning workflow
  - On reject: Send rejection email with reason

**Create: [`app/api/super-admin/partner-requests/[id]/provision/route.ts`](app/api/super-admin/partner-requests/[id]/provision/route.ts)**

- `POST /api/super-admin/partner-requests/[id]/provision` - Provision approved request
  - Create partner record in `partners` table
  - Create primary domain in `partner_domains` table
  - Create temporary password for owner account
  - Create owner user account
  - Add owner to `partner_members` with role 'owner'
  - Update request status to 'approved'
  - Link partner to request
  - Send welcome email with credentials
  - Return partner details

### 4. Super Admin Dashboard Enhancements

**Update: [`app/super-admin/(dashboard)/page.tsx`](app/super-admin/\(dashboard)/page.tsx)**

- Add "Pending Requests" card showing count
- Add "Recent Requests" section
- Quick action button: "Review Requests"

**Create: [`app/super-admin/(dashboard)/partner-requests/page.tsx`](app/super-admin/\(dashboard)/partner-requests/page.tsx)**

- List view of all partner requests
- Filters: Status (pending/approved/rejected), Date range, Search
- Table columns: Company, Contact, Requested Date, Status, Actions
- Status badges with colors
- Quick actions: View, Approve, Reject

**Create: [`app/super-admin/(dashboard)/partner-requests/[id]/page.tsx`](app/super-admin/(dashboard)/partner-requests/[id]/page.tsx)**

- Full request details view
- All submitted information displayed
- Branding preview (logo, colors)
- Subdomain preview
- Action buttons: Approve & Provision, Reject
- Approval modal: Confirm and trigger provisioning
- Rejection modal: Enter reason, send email
- Activity timeline showing status changes

### 5. Email Templates with Resend

**Create: [`lib/email/templates/partner-request-notification.tsx`](lib/email/templates/partner-request-notification.tsx)**

- React Email template for super admin notification
- Shows: Company name, contact email, requested subdomain
- CTA button: "Review Request" (links to super admin dashboard)
- Professional design matching platform branding

**Create: [`lib/email/templates/partner-request-approved.tsx`](lib/email/templates/partner-request-approved.tsx)**

- Welcome email for approved partner
- Includes: Login URL, temporary credentials, next steps
- Branding guidelines
- Support contact information

**Create: [`lib/email/templates/partner-request-rejected.tsx`](lib/email/templates/partner-request-rejected.tsx)**

- Rejection notification
- Includes: Reason for rejection, next steps, contact support
- Professional and empathetic tone

**Update: [`lib/email/send.ts`](lib/email/send.ts)**

- Add functions:
  - `sendPartnerRequestNotification(requestData, adminEmail)`
  - `sendPartnerApprovalEmail(partnerData, ownerEmail, credentials)`
  - `sendPartnerRejectionEmail(requestData, reason)`
- Use test email: `drewcarter112233@gmail.com` for development
- Configure Resend API key in environment

### 6. React Hooks for Partner Requests

**Create: [`lib/hooks/use-partner-requests.ts`](lib/hooks/use-partner-requests.ts)**

- `usePartnerRequests(filters)` - List requests (super admin)
- `usePartnerRequest(id)` - Get single request
- `useApprovePartnerRequest()` - Approve mutation
- `useRejectPartnerRequest()` - Reject mutation
- `useProvisionPartner()` - Provision mutation
- All using React Query with proper cache invalidation

### 7. UI Components

**Create: [`components/marketing/pricing-card.tsx`](components/marketing/pricing-card.tsx)**

- Reusable pricing card component
- Props: plan name, price, features, CTA text, CTA action
- Highlight "Popular" or "Enterprise" badges

**Create: [`components/marketing/partner-request-form.tsx`](components/marketing/partner-request-form.tsx)**

- Multi-step form component
- Progress indicator
- Form validation with React Hook Form + Zod
- File upload for logo
- Color picker integration
- Subdomain checker with debounce

**Create: [`components/super-admin/partner-request-card.tsx`](components/super-admin/partner-request-card.tsx)**

- Display partner request summary
- Status badge, company info, requested date
- Quick action buttons

**Create: [`components/super-admin/partner-request-details.tsx`](components/super-admin/partner-request-details.tsx)**

- Full details view component
- Branding preview
- All form data displayed
- Approval/rejection actions

**Create: [`components/super-admin/approve-partner-dialog.tsx`](components/super-admin/approve-partner-dialog.tsx)**

- Confirmation dialog for approval
- Shows what will be provisioned
- "Approve & Provision" button triggers workflow

**Create: [`components/super-admin/reject-partner-dialog.tsx`](components/super-admin/reject-partner-dialog.tsx)**

- Rejection dialog with reason textarea
- Send rejection email option
- Confirm rejection button

### 8. Type Definitions

**Update: [`types/database.types.ts`](types/database.types.ts)**

- Add `PartnerRequest` interface
- Add `PartnerRequestStatus` type
- Add `PartnerOnboardingStatus` type
- Add Zod schemas for partner request validation

**Update: [`types/api.types.ts`](types/api.types.ts)**

- Add `CreatePartnerRequestInput` type
- Add `ApprovePartnerRequestInput` type
- Add `RejectPartnerRequestInput` type
- Add `ProvisionPartnerInput` type

### 9. Improved Customer Onboarding Flow

**Update: [`app/(auth)/signup/page.tsx`](app/\(auth)/signup/page.tsx)**

- Add "Selected Plan" display if coming from pricing page
- Pass plan selection via URL params
- Show plan benefits during signup

**Update: [`app/api/auth/signup/route.ts`](app/api/auth/signup/route.ts)**

- Track signup source (pricing page, direct, invitation)
- Store selected plan preference in user metadata
- Send welcome email based on plan selection

**Update: [`app/select-workspace/page.tsx`](app/select-workspace/page.tsx)**

- Improved empty state for new customers
- Guided onboarding flow
- "Create Your First Workspace" wizard
- Plan limits displayed

### 10. Configuration & Environment

**Update: [`lib/env.ts`](lib/env.ts)**

- Add `RESEND_API_KEY` (required)
- Add `SUPER_ADMIN_EMAIL` (for notifications)
- Add `NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET` (for logo uploads)

**Create: [`.env.example`](.env.example)**

- Document all required environment variables
- Include Resend setup instructions

### 11. Middleware & Routing Updates

**Update: [`proxy.ts`](proxy.ts)**

- Add public paths for marketing pages: `/pricing`, `/request-partner`
- Ensure marketing pages are accessible without auth

**Create: [`app/(marketing)/page.tsx`](app/\(marketing)/page.tsx)**

- New marketing homepage (different from authenticated landing)
- Hero section with value proposition
- Feature highlights
- Pricing preview with CTA
- Social proof section

### 12. Testing & Validation

**Manual Testing Checklist:**

1. Submit partner request from marketing page
2. Verify email sent to `drewcarter112233@gmail.com`
3. Login as super admin
4. View pending request in dashboard
5. Approve and provision partner
6. Verify partner created with correct branding
7. Verify welcome email sent
8. Test rejection flow with reason
9. Verify rejection email sent
10. Test subdomain availability checker
11. Test logo upload functionality
12. Test customer signup flow with plan selection

## Key Files to Create/Modify

### New Files (23 files)

1. `app/(marketing)/layout.tsx`
2. `app/(marketing)/page.tsx`
3. `app/(marketing)/pricing/page.tsx`
4. `app/(marketing)/request-partner/page.tsx`
5. `app/api/partner-requests/route.ts`
6. `app/api/partner-requests/check-subdomain/route.ts`
7. `app/api/super-admin/partner-requests/route.ts`
8. `app/api/super-admin/partner-requests/[id]/route.ts`
9. `app/api/super-admin/partner-requests/[id]/provision/route.ts`
10. `app/super-admin/(dashboard)/partner-requests/page.tsx`
11. `app/super-admin/(dashboard)/partner-requests/[id]/page.tsx`
12. `lib/email/templates/partner-request-notification.tsx`
13. `lib/email/templates/partner-request-approved.tsx`
14. `lib/email/templates/partner-request-rejected.tsx`
15. `lib/hooks/use-partner-requests.ts`
16. `components/marketing/pricing-card.tsx`
17. `components/marketing/partner-request-form.tsx`
18. `components/super-admin/partner-request-card.tsx`
19. `components/super-admin/partner-request-details.tsx`
20. `components/super-admin/approve-partner-dialog.tsx`
21. `components/super-admin/reject-partner-dialog.tsx`
22. `.env.example`
23. Database migration for `partner_requests` table

### Modified Files (8 files)

1. `app/super-admin/(dashboard)/page.tsx` - Add pending requests section
2. `app/(auth)/signup/page.tsx` - Add plan selection context
3. `app/api/auth/signup/route.ts` - Track signup source
4. `app/select-workspace/page.tsx` - Improved onboarding
5. `lib/email/send.ts` - Add new email functions
6. `lib/env.ts` - Add Resend configuration
7. `proxy.ts` - Add marketing routes
8. `types/database.types.ts` - Add partner request types

## Success Metrics

1. **Professional Onboarding**: Clear separation between customer and partner flows
2. **Super Admin Control**: Full visibility and control over partner provisioning
3. **Email Notifications**: Automated notifications at each step
4. **Brand Consistency**: White-label partners get proper branding setup
5. **Security**: Approval workflow prevents unauthorized partner creation
6. **User Experience**: Smooth, guided flow from marketing to active partner

## Next Steps (Phase 2)

- Stripe integration for automated billing
- Partner self-service portal for branding updates
- Advanced analytics for super admin
- Partner usage monitoring and alerts
- Automated subdomain DNS configuration
- Multi-step partner onboarding wizard
- Partner documentation and knowledge base